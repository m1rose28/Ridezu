<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>ridezu</title>
	  	<link rel="stylesheet" href="themes/ridezu.min.css" />
  		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.1/jquery.mobile.structure-1.1.1.min.css" /> 
  		<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script> 
  		<script src="http://code.jquery.com/mobile/1.1.1/jquery.mobile-1.1.1.min.js"></script> 
		<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyA4touwfWlpbCpS0SKYvqfUOVddPnd0OBA&sensor=true"></script>
  		<script>
  		
  		// these are all custom functions used by ridezu.  these are here temporarily and should all be moved to ridezu.js (they should also be minified)
  		
  		//declare initial variables
  		var p="startp"; 
  		var map;  
	    var geocoder;
	    var myspot;

  		  		
  		//page titles are the pageid's coupled with what shows up in the header
  		
  		var pageTitles = { 
  			"startp":"Welcome to Ridezu" ,
  			"enroll":"Where do you live?" ,
  			"fbp":"Login with Facebook" ,
			"congratp":"Congratulations!",
  			"mainp":"Ridezu" ,
			"calcp":"Ridezunomics",
			"accountp":"My Account",
			"transactionp":"Transaction History",	 
  			"ridesp":"My Rides" ,
  			"profilep":"My Profile" ,
  			"howitworksp":"How it Works",
  			"termsp":"Terms of Service",
  			"faqp":"FAQ's",
  			"rider1p":"Step 1",
  			"rider2p":"Step 2",
  			"rider3p":"Step 3",
  			"ride1p":"Step 1",
  			"ride2p":"Step 2",
  			"ride3p":"Step 3",			
  			"whereworkp":"Where do you work?",			
  			"wherelivep":"Where do you live?"			
			};
		
		//this function adds commas to long numbers (used in ridezunomics)
											
		function addCommas(str){
 		   var arr,int,dec;
		   str += '';

		   arr = str.split('.');
		   int = arr[0] + '';
		   dec = arr.length>1?'.'+arr[1]:'';

 		   return int.replace(/(\d)(?=(\d{3})+$)/g,"$1,") + dec;
		}
		 	
		//this is the calculator function for ridezunomics

		function calcv(){

		miles=document.getElementById('slider1').value;
		utype=document.getElementById('flip-min').value;
		gas=document.getElementById('slider2').value;
		mpg=document.getElementById('slider3').value;
				
		if(utype=='driver'){
			tmiles=miles*240*2;
			ftmiles=addCommas(Math.round(tmiles));
			cost=tmiles/mpg*gas;
			fcost=addCommas(Math.round(cost));
			pickup=.25;
			revpermile=.10;
			totrev=240*2*(pickup+(revpermile*miles));
			ftotrev=addCommas(Math.round(totrev));
			totcarbon=tmiles/mpg*20;
			ftotcarbon=addCommas(Math.round(totcarbon));
			copy="This year you're going to drive <b>"+ftmiles+"</b> miles. In terms of just gas money this will cost you <b>$"+fcost+"</b>, assuming gas prices don't increase.<p>Ridezu can help.<p>By using ridezu you'll collect an estimated <b>$"+ftotrev+"</b> to help offset your gas costs.<p>ps. You'll also free the Earth of <b>"+ftotcarbon+"</b> pounds of CO2 - whew!";
			}
		
		if(utype=='rider'){

			tmiles=miles*240*2;
			ftmiles=addCommas(tmiles);
			cost=Math.round(tmiles/mpg*gas);
			fcost=addCommas(Math.round(cost));
			pickup=.25;
			ridezufee=.25;
			revpermile=.10;
			totrev=240*2*(ridezufee+pickup+(revpermile*miles));
			ftotrev=addCommas(Math.round(totrev));
			savings=Math.round(cost-totrev);
			fsavings=addCommas(Math.round(savings));
			totcarbon=tmiles/mpg*20;
			ftotcarbon=addCommas(Math.round(totcarbon));


			if(savings>0){
			copy="This year you're going to drive <b>"+ftmiles+"</b> miles. In terms of just gas money this will cost you <b>$"+fcost+"</b>, assuming gas prices don't increase.<p>Ridezu can help.<p>By using ridezu you'll still pay <b>$"+ftotrev+"</b> to get to work, but you'll save <b>$"+fsavings+ "</b> in gas, save the miles from your car, and you'll be so green.<p>ps. You'll also free the Earth of <b>"+ftotcarbon+"</b> pounds of CO2 - whew!";
			}

			if(savings<=0){
			copy="This year you're going to drive <b>"+ftmiles+"</b> miles. In terms of just gas money this will cost you <b>$"+fcost+"</b>, assuming gas prices don't increase.<p>By using ridezu you'll pay <b>$"+ftotrev+"</b> to get to work.  This might be a little more than gas, but you'll save the miles from your car, and you'll be so green.<p>ps. You'll also free the Earth of <b>"+ftotcarbon+"</b> pounds of CO2 - whew!";
			}
			}
			showpopup(copy);
		}
		
		//this is the navigation system. which shows (to) and hides (from) pages as well as invokes specific
		//javascript for individual pages to load 
		
		function nav(from,to){		
			document.getElementById('pTitle').innerHTML=pageTitles[to];
			document.getElementById("footer").style.display="none";
			document.getElementById(p).style.display="none";		
			scrollTo(0,0);
			document.getElementById(to).style.display="block";
			p=to;
			
			if(to=="termsp"){
				loadterms();
				}

			if(to=="whereworkp"){
				loadMap();
				}

			if(to=="enroll"){
			  	copy="First, type in or select your home address.<br><br>This address never be shared.";
			  	showpopup(copy);
			  	getLocation();
				}

          	if(to=="mainp"){
				document.getElementById("footer").style.display="block";
				}
				
			if(to=="transactionp"){
				$("tr:odd").css("background-color", "#ffffff");
				}

			if(to=="fbp"){
				facebook();
				}
		}

		//this removes the popup when you click on it.   

		function showpopup(content){
			document.getElementById("darkpage").style.display="block";
			document.getElementById('rpopup').innerHTML=content;
			document.getElementById('rpopup').style.display="block";
			}

		function rempopup(){
			document.getElementById("darkpage").style.display="none";
			document.getElementById("rpopup").style.display="none";
			}
		
		//this is a function to load html via ajax (need to generalize for all pages loaded via ajax)
		
		function loadterms(){
			$.ajax({
  			url: "terms.html",
  			cache: true
			}).done(function( html ) {
  				document.getElementById('termsp').innerHTML=html;
				});
		}
		
		//this is the main map function (method is type of function, e.g. enroll, myspot is lat/long, and zoom level is obvious :-)

  		function loadMap(method,myspot,zoomlevel){
  	        
        	geocoder = new google.maps.Geocoder();
        
        	var mapOptions = {
            	center: myspot,
            	zoom: zoomlevel,
            	mapTypeId: google.maps.MapTypeId.ROADMAP,
            	panControl: false,
    	    	zoomControl: false,
    			mapTypeControl: false,
  		  		scaleControl: false,
  		  		streetViewControl: false,
  		  		overviewMapControl: false
          		};
  
	        var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
  
	        var targetDiv = document.createElement('div');
          
     	    targetDiv.innerHTML = '<img style="margin-top:-30px;" src="images/circle.png"/>';
  			targetDiv.style.postion = 'absolute';
  			targetDiv.style.left = '50%';
  			targetDiv.style.top = '50%';
  			targetDiv.style.height = '50px';
	        targetDiv.index = 1;
	        map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(targetDiv);

	        google.maps.event.addListener(map, 'center_changed', function() {
    			window.setTimeout(function() { 
        		a=map.getCenter();
            	codeLatLng();
           		marker1.setPosition(a);
           		}, 500);
  			});
                                               
	      	var image = 'images/marker.png';   
      	
	      	var marker1 = new google.maps.Marker({
    			position: myspot,
    			icon:image,
				});

			// adds the initial marker to the page
			marker1.setMap(map);
			codeLatLng();
      	
      	// this function turns lat/long into a real address  
  	  	function codeLatLng() {
		    var ctr = map.getCenter();
  			var lat = ctr.lat();
  			var lng = ctr.lng();
      		var latlng = new google.maps.LatLng(lat, lng);
      		geocoder.geocode({'latLng': latlng}, function(results, status) {
        		if (status == google.maps.GeocoderStatus.OK) {
          			if (results[1]) {
      	      			locationselect(results[0].formatted_address,lat,lng);
          				}
        			} else {
          			alert("Geocoder failed due to: " + status);
        			}
      			});
    		}             
  		}
  
		//this function set(2) gets your actual location (used only at enroll, the balance of the time we'll have your address)	
		function getLocation(){
  			if (navigator.geolocation){
    			navigator.geolocation.getCurrentPosition(showPosition);
    			}
  				else{alert("Yikes - geolocation is not supported by this browser. Go fish.");}
  				}

		function showPosition(position){
			var myspot = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
			loadMap("enroll",myspot,18);
  			}
  		
		// this is a map function which places the value of the user location in the text field of location
		function locationselect(location,lat,lng){
  			document.getElementById('location').value=location;
  			document.getElementById('lat').value=lat;
  			document.getElementById('lng').value=lng;
		}

		// this function parses/stores the home address and then moves to the work address
		function enrollhome(){
			eloc=document.getElementById('location').value;
			var str1 = eloc.split(',');
			var str2 = str1[2].split(" ");
			localStorage.hadd1=str1[0];
			localStorage.hstate=str2[1];
			localStorage.hcity=str1[1];
			localStorage.hzip=str2[2];
			localStorage.hcountry=str1[3];
			localStorage.hlat=document.getElementById('lat').value;
			localStorage.hlng=document.getElementById('lng').value;
			document.getElementById("mapselecthome").style.display="none";
			document.getElementById("mapselectwork").style.display="block";
			document.getElementById('pTitle').innerHTML="Where do you work?";
		  	copy="Well done!<br><br>Next, please tell us where you work.";
		  	showpopup(copy);
			}

		// this function parses/stores the home address and then moves to the work address
		function enrollwork(){
			eloc=document.getElementById('location').value;
			var str1 = eloc.split(',');
			var str2 = str1[2].split(" ");
			localStorage.wadd1=str1[0];
			localStorage.wstate=str2[1];
			localStorage.wcity=str1[1];
			localStorage.wzip=str2[2];
			localStorage.wcountry=str1[3];
			localStorage.wlat=document.getElementById('lat').value;
			localStorage.wlng=document.getElementById('lng').value;
			//need to store here
			nav('enroll','fbp');
			}

		// below are the facebook functions.  they are optimized purely for the enrollment flow to get data from the user.
		// they are loaded from calling facebook();
		function facebook(){
		  document.getElementById('login').style.display="block";
		  document.getElementById('logout').style.display="block";
		  window.fbAsyncInit = function() {
			FB.init({
			  appId      : '443508415694320', // App ID
			  channelUrl : 'ec2-50-18-0-33.us-west-1.compute.amazonaws.com/channel.html', // Channel File
			  status     : true, // check login status
			  cookie     : true, // enable cookies to allow the server to access the session
			  xfbml      : true  // parse XFBML
			});
		
			FB.Event.subscribe('auth.statusChange', handleStatusChange);
		  };
		
		  // Load the SDK Asynchronously
		  (function(d){
			 var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
			 if (d.getElementById(id)) {return;}
			 js = d.createElement('script'); js.id = id; js.async = true;
			 js.src = "//connect.facebook.net/en_US/all.js";
			 ref.parentNode.insertBefore(js, ref);
		   }(document));
		
		  function handleStatusChange(response) {
			  document.body.className = response.authResponse ? 'connected' : 'not_connected';
			  if (response.authResponse) {
				console.log(response);
		
				updateUserInfo(response);
			  }
			}
		  function updateUserInfo(response) {
			 FB.api('/me', function(response) {
			   document.getElementById('user-info').innerHTML = '<br/<br/>ps.  I got all your data. <br/<br/><img src="https://graph.facebook.com/' + response.id + '/picture">' + response.name;
			   localStorage.first_name=response.first_name;
			   localStorage.last_name=response.last_name;
			   localStorage.image="https://graph.facebook.com/" + response.id + "/picture";
			   localStorage.fbid=response.id;
			   localStorage.email=response.email;
			   document.getElementById('fname').innerHTML=response.first_name
			   // now register the new user
			   regnewuser();
			   //and go to the congratulations page
			   nav("fbp","congratp");
			 });
		   }
		}
		
		function loginUser() {    
			 FB.login(function(response) { }, {scope:'email'});     
			 }
		
		function logoutUser() {    
			 FB.logout();
			 alert("Logged-out");
			 document.getElementById('user-info').innerHTML="";
			 }

// this function set 2 creates a new user
							
		function regnewuser(){
			var dataset = {
				"fbid":	localStorage.fbid,
				"fname": localStorage.first_name,
				"lname": localStorage.last_name,
				"add1": localStorage.hadd1,
				"city": localStorage.hcity,
				"state": localStorage.hstate,	
				"zip": localStorage.hzip,
				"workadd1": localStorage.wadd1,
				"workcity": localStorage.wcity,
				"workstate": localStorage.wstate,	
				"workzip": localStorage.wzip,
				"email": localStorage.email,
				"homelatlong": localStorage.hlat+","+localStorage.hlng,
				"worklatlong": localStorage.wlat+","+localStorage.wlng,
				}
				
			var jsondataset = JSON.stringify(dataset);
		
		    var request=$.ajax({
                url: "http://ec2-50-18-0-33.us-west-1.compute.amazonaws.com/ridezu/api/users",
                type: "POST",
                dataType: "json",
                data: jsondataset,
                success: function() {},
                error: function() { alert('already registered?'); },
                beforeSend: setHeader
            	}); 
            	
            request.done(function(msg) {
  				localStorage.seckey=msg.seckey;
				});                	     	
       		}

        function setHeader(xhr) {
            xhr.setRequestHeader("X-Signature", "f8435e6f1d1d15f617c6412620362c21");
            xhr.setRequestHeader("Content-Type", "application/json");
  	      }
        
			
		</script>
 		<!-- these are custom styles used by ridezu (in addition to jquery mobile styles).   these are here temporarily and should all be moved to ridezu.css -->
		<style>
		 .popup{
		 position: absolute; 
		 top:25%; 
		 left:10%; 
		 width:80%; 
		 z-index: 150; 
		 background-color: #FAFA93;
		 border:1px solid #FA820A;
		 -moz-border-radius: 15px;
		 border-radius: 15px;
		 padding:10px;
		 margin:0px;
		 }
		 .footerlink{
		 padding:10px;
		 font-size:12px;
		 color:white;
		 text-decoration:none;
		 display:inline;
		 }
		 .footerbar{
		 padding:10px;
		 font-size:12px;
		 color:white;
		 width:100%;
		 text-align:center;
		 }
		 table {
   		 background:#cccccc;
   		 width:100%;
		 border-spacing:0;
  		 border-collapse:collapse;
  		 }
  		 td {
  		 padding:5px;
  		 }
  		 .pageTitle{
  		 font-weight:bold;
  		 color:#fffff;
  		 width:80%;
  		 padding:10px;
  		 text-align:center;
  		 }
  		 #location{
  		 position: absolute;
  		 top:40px;
  		 left:10%;
  		 width:80%;
  		 z-index:100;
  		 }
  		 .mapselect{
  		 position: absolute;
  		 top:80%;
  		 left:10%;
  		 width:80%;
  		 z-index:100;
  		 }

		.dim {
		background: none repeat scroll 0 0 rgba(0, 0, 0, 0.8);
		height: 500px;
		left: 0;
		position: absolute;
		top: 0;
		width: 100%;
		z-index: 125;
		}
		 </style>	

	</head>
<body>
 
 <!-- Start of app + header -->
 <div data-role="page" id="home1" data-theme="a" style="width:100%;">		
	<div data-role="header" data-position="inline" style="display:block;width:100%;">
				<a id="homeicon" onclick="nav('','mainp');" data-icon="home" data-iconpos="notext">Home</a>
				<div class="pageTitle" id="pTitle">Ridezu</div>
			</div>
	<div data-role="content" data-theme="a" style="padding:0px;margin:0px;width:100%;">
	<div id="rpopup" style="display:none;" onclick="rempopup();" class="popup"></div>
	<div id="darkpage" class="dim" style="display:none;"></div>

 <!-- Start of main page: #mainp -->
	<div id="mainp" style="display:none;padding:10px;"></div>
 <!-- end of main page: #mainp -->

 
 <!-- Start of start page: #startp -->
	<div id="startp" style="display:block;padding:10px;">
			<br/><br/>
			Welcome to Ridezu - a revolutionary way to carpool.
			<br/><br/>
			<center>
			<img src="http://i.imgur.com/bvTCX.jpg"/>
			</center>
			<br/><br/>					
			<div onclick="nav('mainp','enroll');" data-role="button" data-icon="arrow-r" data-iconpos="right">Start</div>
			<br/><br/><br/><br/><br/>
		</div>
<!-- end of start page: #startp -->
			
			
<!-- Start of enroll div -->
	<div id="enroll" style="display:none;">
    	<fieldset style="text-align:center;padding:0px;margin:0px;">
		<input type="text" id="location" value=""/>
		<input type="text" id="lat" value="" style="display:none;"/>
		<input type="text" id="lng" value="" style="display:none;"/>
		<div id="mapselecthome" class="mapselect" onclick="enrollhome();" data-role="button" data-icon="arrow-r" data-iconpos="right">Next</div>
		<div id="mapselectwork" class="mapselect" onclick="enrollwork();" data-role="button" data-icon="arrow-r" data-iconpos="right" style="display:none;">Next</div>
		<div id="map_canvas" style="width:100%; height:400px;"></div>
    	</fieldset> 
	</div>
<!-- end of enroll div  -->

<!-- Start of fb div -->
 	<div id="fbp" style="display:none;padding:10px;">
		<style>
  			body.connected #login { display: none; }
  			body.connected #logout { display: block; }
  			body.not_connected #login { display: block; }
  			body.not_connected #logout { display: none; }
		</style>

		<div id="fb-root"></div>
 	
		<br/><br/>Please login with Facebook.  
		<br/><br/>
		We're a green company focused on social good.  We'll never spam you or abuse your trust.
		<br/><br/>
		<center>
		<img src="images/fb_icon.gif"/>
		
		<div id="login" onclick="loginUser();" data-role="button" data-icon="arrow-r" data-iconpos="right">Login with Facebook</div>
	    <br><br><div id="logout"><a onClick="logoutUser()" >Logout (testing)</a></div>

		<div id="user-info"></div>
		</center>
	</div>
<!-- end of fb div  -->

<!-- Start of congrat div -->
	<div id="congratp" style="display:none;padding:10px;">
		<br/><b>Congratulations <span id="fname"></span>, you're now signed up for Ridezu.</b>
		<br/><br/>
		We're putting together routes in your area and will let you know when you can start.
		<br/><br/>
		Until then, why don't you take the tour on how it works and complete your profile.
		<br/><br/>
		<div onclick="nav('congratp','mainp');" data-role="button" data-icon="arrow-r" data-iconpos="right">Next</div>
	</div>
<!-- end of congrat div  -->

	</div>

	<div id="footer" data-role="footer">
		<div class="footerbar"> 
		<div class="footerlink" href="" onclick="nav('mainp','termsp');">Terms</div> | 
		<div class="footerlink" href="" onclick="nav('mainp','termsp');">Privacy</div>
		&copy; 2012
		</div>
	</div>
			 			 						
</div>
</body>
</html>